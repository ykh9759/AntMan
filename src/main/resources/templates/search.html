<!DOCTYPE html>
<html>
<th:block th:include="~{common/include}"></th:block>
<link rel="stylesheet" type="text/css" th:href="@{/css/search.css}">
<body>
<div class="container">
    <th:block th:include="~{common/header}"></th:block>
	<div class="row">
		<div class="search">
			<div class="searchWrapper">
				<button onclick="sendit();" ><i class="fa fa-search"></i></button>
				<input type="text" id="search" onkeyup="enterkey()" value="삼성전자"/>
			</div>
		</div>
	</div>
    <div class="row">
        <div id="element" class="col-sm-12 pb-4 px-4"></div>
    </div>
    <th:block th:include="~{common/footer}"></th:block>
</div>
<script th:inline="javascript">

//엔터키로 검색
function enterkey() {
	if (window.event.keyCode == 13) {
		sendit();
	}
}

function sendit() {

	var search = document.getElementById("search").value;

	if(!search) {
		alert("종목명을 입력해 주세요.");
		return;
	}
	
	$.ajax({
		type:"GET", // 전송 방식 GET , POST , PUT , DELETE
		url:"/stock/search", // 전송할 경로
		data: {"search":search} , // 전송할 키와 값
		dataType:"JSON", // 반환되는 값의 형식 json , text 를 주로 사용
		beforeSend : function () {
		// 전송 전 작업 , 화면을 흐르게 하기..
		},
		success : function(data) {

            if ( typeof(data) == "undefined" ) return;

			var div1 = document.createElement("div");
			div1.className = "card";

			var div2 = document.createElement("div");
			div2.className = "card-body";

			var div3 = document.createElement("div");
			div3.id = "chart";

			var element = document.getElementById("element");
			element.appendChild(div1).appendChild(div2).appendChild(div3);

			var dataArray = new Array();
			var dateArray = new Array();
			for(var i = 0; i <data.length+1; i++) {

				if(i == 0) {
					dataArray[0] = "KOSPI";
					dateArray[0] = "x";

				} else {
					dataArray[i] = [parseInt(data[i-1].mkp), parseInt(data[i-1].hipr), parseInt(data[i-1].lopr), parseInt(data[i-1].clpr)];
					dateArray[i] = (data[i-1].basDt).slice(0,4) + "-"+ (data[i-1].basDt).slice(4,6) + "-" + (data[i-1].basDt).slice(6,8);
				}
			}

			//columns [시가, 최고, 최저, 종가]
			var kospi = bb.generate({
				title: {
					text: search + " 차트"
				},
				data: {
					x: dateArray[0],
					columns: [
						dataArray,
						dateArray
					],
					type: "candlestick", // for ESM specify as: candlestick()
					colors: {
						KOSPI: "red"
					},
				},
				candlestick: {
					color: {
						down: "blue"
					},
					width: {
						ratio: 0.4
					}
				},
				axis: {
					x: {
						type: "timeseries",
						tick: {
							count: 8,
							format: "%m-%d"
						}
					},
					y: {
						show: false
					},
					y2: {
						show: true
					}
				},
				bindto: "#chart"
			});
			
		},
		complete : function() {
		// 성공여부와 상관없이 ajax 완료후 작업 
		},
		error : function(request, status, errorr) {
		// 에러가 났을 경우의 작업
		}
	}); // end ajax
}
</script>
</body>
</html>